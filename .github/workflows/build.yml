 name: Build e Deploy

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Build
        run: |
          chmod +x gradlew
          
          # Executa build
          output=$(./gradlew :SuperFlix:assembleDebug --stacktrace 2>&1)
          status=$?
          
          if [ $status -eq 0 ]; then
            echo "âœ… Build OK"
            
            # Copia arquivo
            file=$(find . -name "*.cs3" -type f | head -1)
            mkdir -p out
            cp "$file" out/SuperFlix.cs3
          else
            echo "âŒ Build falhou"
            echo "$output" | grep -E "^e: |error:|FAIL" | head -15
            exit 1
          fi
          
      - name: Criar JSONs
        if: success()
        run: |
          cat > out/plugins.json << 'EOF'
          [
            {
              "name": "SuperFlix",
              "url": "https://raw.githubusercontent.com/lawlietbr/lietrepo/main/out/SuperFlix.cs3"
            }
          ]
          EOF
          
      - name: Commitar
        if: success()
        run: |
          git config user.name "GitHub Bot"
          git config user.email "bot@github.com"
          git add out/
          git commit -m "build"
          
      - name: Push para main  # ðŸ”¥ PUSH SEPARADO
        if: success()
        run: git push
