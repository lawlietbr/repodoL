name: Build SuperFlix

on:
  workflow_dispatch:
  push:
    branches: -main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Build plugin
        run: |
          chmod +x gradlew
          ./gradlew :SuperFlix:assembleDebug
          
      - name: Gerar plugins.json
        run: |
          ./gradlew makePluginsJson -PoutputFile="build/plugins.json"
          
      - name: Criar repositÃ³rio
        run: |
          REPO_BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/builds"
          PLUGINS_LIST="[\"$REPO_BASE_URL/plugins.json\"]"
          
          mkdir -p builds
          
          if [ -f "build/plugins.json" ]; then
            mv build/plugins.json builds/plugins.json
          fi
          
          REPO_BASE_URL_ESCAPED=$(echo "$REPO_BASE_URL" | sed 's/[&/\]/\\&/g')
          sed -i.bak "s|\"url\": \"[^\"]*/([^/]+)\.cs3\"|\"url\": \"$REPO_BASE_URL_ESCAPED/\1.cs3\"|g" builds/plugins.json
          sed -i.bak "s|\"jarUrl\": \"[^\"]*/([^/]+)\.jar\"|\"jarUrl\": \"$REPO_BASE_URL_ESCAPED/\1.jar\"|g" builds/plugins.json
          
          cat > builds/repo.json << EOF
            {
  "name": "lietrepo",
  "iconUrl": "https://github.com/lawlietbr.png",
  "description": "RepositÃ³rio BR do CloudStream",
  "manifestVersion": 1,
  "pluginLists": $PLUGINS_LIST
                     }
                    EOF
          
      - name: Copiar arquivos
        run: |
          find . -type f -name "*.cs3" -exec cp {} builds/ \; 2>/dev/null || true
          find . -type f -name "*.jar" -exec cp {} builds/ \; 2>/dev/null || true
          
      - name: Commit e push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add builds/
          git commit -m "ðŸš€ Build"
          git push
