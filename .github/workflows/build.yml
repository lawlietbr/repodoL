name: Build SuperFlix

on:
  workflow_dispatch:
  push:
    branches: -main

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Build plugin
        run: |
          chmod +x gradlew
          ./gradlew :SuperFlix:assembleDebug
          
      - name: Gerar plugins.json
        run: |
          ./gradlew makePluginsJson -PoutputFile="build/plugins.json"
          
      - name: Criar repositÃ³rio
        run: |
          mkdir -p builds
          
          if [ -f "build/plugins.json" ]; then
            cp build/plugins.json builds/plugins.json
          fi
          
          # Corrigir URLs
          BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/builds"
          sed -i "s|\"url\": \".*\.cs3\"|\"url\": \"$BASE_URL/SuperFlix.cs3\"|g" builds/plugins.json
          
          # Criar repo.json SIMPLES
          echo '{"name":"SuperFlix","pluginLists":["'"$BASE_URL/plugins.json"'"]}' > builds/repo.json
          
      - name: Copiar arquivos
        run: |
          find . -name "*.cs3" -type f -exec cp {} builds/ \;
          
      - name: Commit e push
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add builds/
          git commit -m "build"
          git push
