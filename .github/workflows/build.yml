name: Build Completo SuperFlix

on:
  workflow_dispatch:
  push:
    branches: [main]

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. CHECKOUT
      - name: Checkout c√≥digo
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. BUILD
      - name: Compilar plugin
        run: |
          echo "üîÑ Compilando SuperFlix..."
          chmod +x gradlew
          
          # Build completo
          ./gradlew :SuperFlix:clean :SuperFlix:assembleDebug \
            --no-daemon \
            --console=plain
          
          # Verificar se gerou
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          
          if [ -f "$CS3_FILE" ]; then
            echo "‚úÖ Plugin gerado: $(basename "$CS3_FILE")"
            echo "üìè Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
          else
            echo "‚ùå Nenhum .cs3 encontrado!"
            exit 1
          fi
          
      # 3. GERAR JSONs
      - name: Gerar plugins.json
        run: |
          echo "üìÑ Gerando plugins.json..."
          
          # Tenta gerar o plugins.json
          ./gradlew makePluginsJson -PoutputFile="build/plugins.json" 2>/dev/null || true
          
          # Se n√£o gerou, cria um manual
          if [ ! -f "build/plugins.json" ]; then
            echo "‚ö†Ô∏è Gradle n√£o gerou, criando manualmente..."
            
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            CS3_NAME=$(basename "$CS3_FILE")
            CS3_SIZE=$(stat -c%s "$CS3_FILE")
            
            cat > build/plugins.json << EOF
            [
              {
                "name": "SuperFlix",
                "pkg": "com.SuperFlix",
                "apk": "$CS3_NAME",
                "lang": "pt-br",
                "code": 1,
                "version": "1.0",
                "versionName": "1.0.0",
                "nsfw": false,
                "hasAds": false,
                "source": "https://superflix21.lol",
                "file": "$CS3_NAME",
                "url": "https://raw.githubusercontent.com/${{ github.repository }}/main/builds/$CS3_NAME",
                "iconUrl": "https://raw.githubusercontent.com/lawlietbr/lietrepo/main/.github/icons/superflix.png",
                "desc": "SuperFlix - Filmes, S√©ries e Animes em portugu√™s",
                "website": "",
                "changelog": "",
                "changelogMedia": ""
              }
            ]
            EOF
          fi
          
          echo "‚úÖ plugins.json gerado"
          
      # 4. PREPARAR ARQUIVOS FINAIS
      - name: Preparar build final
        run: |
          echo "üì¶ Preparando arquivos finais..."
          
          # Cria pasta builds
          mkdir -p builds
          
          # Copia .cs3
          CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
          if [ -f "$CS3_FILE" ]; then
            cp "$CS3_FILE" "builds/"
            echo "‚úÖ .cs3 copiado para builds/"
          fi
          
          # Copia plugins.json
          if [ -f "build/plugins.json" ]; then
            cp "build/plugins.json" "builds/"
            echo "‚úÖ plugins.json copiado para builds/"
          fi
          
          # Cria repo.json
          cat > builds/repo.json << EOF
          {
            "name": "lietrepo",
            "iconUrl": "https://github.com/lawlietbr.png",
            "description": "Reposit√≥rio BR do CloudStream",
            "manifestVersion": 1,
            "pluginLists": [
              "https://raw.githubusercontent.com/${{ github.repository }}/main/builds/plugins.json"
            ]
          }
          EOF
          echo "‚úÖ repo.json criado"
          
          # Cria index.html para GitHub Pages
          cat > builds/index.html << EOF
          <!DOCTYPE html>
          <html>
          <head>
              <title>SuperFlix Repository</title>
              <meta charset="utf-8">
              <style>
                  body { font-family: Arial, sans-serif; max-width: 800px; margin: 40px auto; padding: 20px; }
                  .plugin { border: 1px solid #ddd; padding: 20px; margin: 20px 0; border-radius: 8px; }
                  .download-btn { background: #007acc; color: white; padding: 10px 20px; text-decoration: none; border-radius: 5px; }
              </style>
          </head>
          <body>
              <h1>üé¨ SuperFlix Repository</h1>
              <p>Reposit√≥rio do plugin SuperFlix para CloudStream 3</p>
              
              <div class="plugin">
                  <h2>SuperFlix</h2>
                  <p><strong>Descri√ß√£o:</strong> Filmes, S√©ries e Animes em portugu√™s</p>
                  <p><strong>Idioma:</strong> pt-br</p>
                  <p><strong>Vers√£o:</strong> 1.0.0</p>
                  <a class="download-btn" href="SuperFlix.cs3">üì• Baixar Plugin</a>
              </div>
              
              <h3>üì± Como instalar:</h3>
              <ol>
                  <li>Abra o CloudStream 3</li>
                  <li>V√° em: Configura√ß√µes ‚Üí Extens√µes</li>
                  <li>Clique em: "Instalar de URL"</li>
                  <li>Cole esta URL: <code>https://raw.githubusercontent.com/${{ github.repository }}/main/builds/SuperFlix.cs3</code></li>
                  <li>Clique em Instalar e reinicie o app</li>
              </ol>
              
              <h3>üîó Links:</h3>
              <ul>
                  <li><a href="SuperFlix.cs3">Plugin (.cs3)</a></li>
                  <li><a href="plugins.json">Lista de plugins (JSON)</a></li>
                  <li><a href="repo.json">Configura√ß√£o do reposit√≥rio</a></li>
              </ul>
          </body>
          </html>
          EOF
          echo "‚úÖ index.html criado"
          
          # Lista arquivos
          echo ""
          echo "üìÅ Conte√∫do da pasta builds/:"
          ls -la builds/
          
      # 5. COMMIT TUDO
      - name: Commit arquivos
        run: |
          echo "üì§ Committing arquivos..."
          
          # Configura git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Adiciona tudo na pasta builds
          git add builds/
          
          # Verifica se tem altera√ß√µes
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è Nenhuma altera√ß√£o para commit"
          else
            git commit -m "üöÄ Build completo: SuperFlix + JSONs - $(date +'%d/%m %H:%M')"
            git push
            echo "‚úÖ Arquivos commitados com sucesso!"
          fi
          
      # 6. RELAT√ìRIO FINAL
      - name: Relat√≥rio final
        if: always()
        run: |
          echo "üéâ BUILD COMPLETO!"
          echo ""
          echo "üìä ARQUIVOS GERADOS:"
          echo "1. builds/SuperFlix.cs3 - Plugin principal"
          echo "2. builds/plugins.json - Lista de plugins"
          echo "3. builds/repo.json - Config do reposit√≥rio"
          echo "4. builds/index.html - P√°gina web"
          echo ""
          echo "üîó URLs PARA USAR:"
          echo ""
          echo "üì± PARA INSTALAR NO CLOUDSTREAM:"
          echo "URL: https://raw.githubusercontent.com/${{ github.repository }}/main/builds/SuperFlix.cs3"
          echo ""
          echo "üìÑ PARA ADICIONAR REPOSIT√ìRIO:"
          echo "URL: https://raw.githubusercontent.com/${{ github.repository }}/main/builds/repo.json"
          echo ""
          echo "üåê P√ÅGINA WEB:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/builds/index.html"
