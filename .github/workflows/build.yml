name: Build SuperFlix Completo

on:
  workflow_dispatch:
  push:
    branches: [main]  # üî• AQUI ESTAVA O ERRO!

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      # 1. CHECKOUT
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      # 2. SETUP JAVA
      - name: Setup Java
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      # 3. BUILD PLUGIN
      - name: Build plugin
        run: |
          chmod +x gradlew
          
          echo "üî® Compilando SuperFlix..."
          
          # Build principal
          ./gradlew :SuperFlix:assembleDebug --stacktrace 2>&1 | tee build_output.txt
          
          # Verifica se passou
          if [ ${PIPESTATUS[0]} -eq 0 ]; then
            echo "‚úÖ Build bem-sucedido"
            
            # Mostra arquivo gerado
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            if [ -f "$CS3_FILE" ]; then
              echo "üì¶ Plugin: $(basename "$CS3_FILE")"
              echo "üìè Tamanho: $(ls -lh "$CS3_FILE" | awk '{print $5}')"
            fi
          else
            echo "‚ùå Build falhou"
            grep -E "^e: |error:|FAIL|‚úó|‚ùå" build_output.txt | head -15
            exit 1
          fi
          
      # 4. GERAR plugins.json AUTOM√ÅTICO
      - name: Gerar plugins.json autom√°tico
        run: |
          echo "=== GERANDO PLUGINS.JSON ==="
          
          # Usa o gradle para gerar plugins.json
          ./gradlew makePluginsJson -PoutputFile="build/plugins.json" --info
          
          echo "Verificando plugins.json..."
          if [ -f "build/plugins.json" ]; then
            echo "‚úÖ plugins.json gerado com sucesso"
            echo "üìè Tamanho: $(stat -c%s "build/plugins.json") bytes"
            echo "üìÑ Primeiras linhas:"
            head -5 build/plugins.json
          else
            echo "‚ö†Ô∏è Gradle n√£o gerou, criando manualmente..."
            
            # Cria manualmente se necess√°rio
            CS3_FILE=$(find . -name "*.cs3" -type f | head -1)
            CS3_NAME=$(basename "$CS3_FILE")
            
            cat > build/plugins.json << 'EOF'
[
  {
    "name": "SuperFlix",
    "pkg": "com.SuperFlix",
    "apk": "SuperFlix.cs3",
    "lang": "pt-br",
    "code": 1,
    "version": "1.0",
    "versionName": "1.0.0",
    "nsfw": false,
    "hasAds": false,
    "source": "https://superflix21.lol",
    "file": "SuperFlix.cs3",
    "url": "https://raw.githubusercontent.com/${{ github.repository }}/builds/SuperFlix.cs3",
    "desc": "SuperFlix - Filmes, S√©ries e Animes em portugu√™s"
  }
]
EOF
            echo "‚úÖ plugins.json criado manualmente"
          fi
          echo "=== FIM ==="
          
      # 5. CRIAR REPOSIT√ìRIO E CORRIGIR URLs
      - name: Criar reposit√≥rio com URLs corrigidas
        run: |
          echo "=== CRIANDO REPOSIT√ìRIO ==="
          
          # Define URL base
          REPO_BASE_URL="https://raw.githubusercontent.com/${{ github.repository }}/main/builds"
          PLUGINS_LIST="[\"$REPO_BASE_URL/plugins.json\"]"
          
          echo "üîó REPO_BASE_URL: $REPO_BASE_URL"
          echo "üì¶ Reposit√≥rio: ${{ github.repository }}"
          
          # Cria pasta builds
          mkdir -p builds
          
          # Move plugins.json para builds
          if [ -f "build/plugins.json" ]; then
            cp build/plugins.json builds/plugins.json
            echo "‚úÖ plugins.json copiado para builds/"
          else
            echo "‚ùå ERRO: build/plugins.json n√£o encontrado!"
            exit 1
          fi
          
          # Verificar plugins.json
          echo "üîç Verificando plugins.json (primeiras 3 entradas):"
          jq '.[0:3]' builds/plugins.json 2>/dev/null || head -20 builds/plugins.json
          
          # Escapa a URL para uso no sed
          REPO_BASE_URL_ESCAPED=$(echo "$REPO_BASE_URL" | sed 's/[&/\]/\\&/g')
          echo "üîß REPO_BASE_URL_ESCAPED (para sed): $REPO_BASE_URL_ESCAPED"
          
          # Corrige URLs internas do plugins.json (.cs3)
          echo "üîß Corrigindo URLs .cs3..."
          sed -i.bak -E "s|\"url\": \"[^\"]*/([^/]+)\.cs3\"|\"url\": \"$REPO_BASE_URL_ESCAPED/\1.cs3\"|g" builds/plugins.json
          
          # Corrige URLs internas do plugins.json (.jar)
          echo "üîß Corrigindo URLs .jar..."
          sed -i.bak -E "s|\"jarUrl\": \"[^\"]*/([^/]+)\.jar\"|\"jarUrl\": \"$REPO_BASE_URL_ESCAPED/\1.jar\"|g" builds/plugins.json
          
          # Verificar corre√ß√µes
          echo "‚úÖ URLs corrigidas (amostra):"
          grep -n "url" builds/plugins.json | head -5
          
          # Cria repo.json final
          echo "üìÑ Criando repo.json..."
          cat > builds/repo.json << 'EOF'
{
  "name": "lietrepo",
  "iconUrl": "https://github.com/lawlietbr.png",
  "description": "Reposit√≥rio BR do CloudStream",
  "manifestVersion": 1,
  "pluginLists": $PLUGINS_LIST
}
EOF
          
          # Adiciona a lista de plugins no repo.json
          sed -i "s|\"pluginLists\":.*|\"pluginLists\": $PLUGINS_LIST|" builds/repo.json
          
          echo "‚úÖ repo.json criado:"
          cat builds/repo.json
          
      # 6. COPIAR ARQUIVOS COMPILADOS
      - name: Copiar arquivos compilados
        run: |
          echo "üìÇ Procurando arquivos compilados..."
          
          echo "üì¶ Arquivos .cs3 encontrados:"
          find . -type f -name "*.cs3" 2>/dev/null | head -10
          
          echo "üì¶ Arquivos .jar encontrados:"
          find . -type f -name "*.jar" 2>/dev/null | head -10
          
          echo "üìÇ Copiando para builds/..."
          
          # Copia .cs3
          find . -type f -name "*.cs3" -exec echo "üìã Copiando: {}" \; -exec cp {} builds/ \; 2>/dev/null || true
          
          # Copia .jar
          find . -type f -name "*.jar" -exec echo "üìã Copiando: {}" \; -exec cp {} builds/ \; 2>/dev/null || true
          
          echo "üìÅ Arquivos em builds/:"
          ls -la builds/
          
      # 7. VERIFICA√á√ÉO DO PLUGIN
      - name: Verificar plugin compilado
        run: |
          echo "=== DEBUG PLUGIN COMPILADO ==="
          
          # Encontrar o plugin SuperFlix
          PLUGIN_FILE=$(find builds -name "*SuperFlix*.cs3" 2>/dev/null | head -1)
          
          if [ -n "$PLUGIN_FILE" ] && [ -f "$PLUGIN_FILE" ]; then
            echo "‚úÖ Plugin encontrado: $PLUGIN_FILE"
            echo "üìè Tamanho: $(stat -c%s "$PLUGIN_FILE") bytes"
            
            # Extrair strings do plugin para verificar
            echo "üîç Buscando refer√™ncias no plugin..."
            strings "$PLUGIN_FILE" | grep -i "tmdb\|api_key\|BuildConfig\|superflix" | head -10 || echo "‚ö†Ô∏è Nenhuma refer√™ncia encontrada"
            
            # Verificar se h√° refer√™ncia √† API TMDB
            if strings "$PLUGIN_FILE" | grep -q "api.themoviedb.org\|workers.dev"; then
              echo "‚úÖ Plugin faz refer√™ncia √† API/proxy"
            else
              echo "‚ö†Ô∏è Plugin N√ÉO faz refer√™ncia √† API TMDB"
            fi
          else
            echo "‚ùå Nenhum plugin SuperFlix encontrado em builds/"
            echo "üìÅ Arquivos em builds/:"
            ls -la builds/ 2>/dev/null || echo "Diret√≥rio builds/ n√£o existe"
          fi
          
          echo "=== FIM DEBUG ==="
          
      # 8. COMMIT E PUSH
      - name: Commit e push
        run: |
          echo "üì§ Committing arquivos..."
          
          # Configura git
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          
          # Adiciona tudo na pasta builds
          git add builds/
          
          # Verifica se tem altera√ß√µes
          if git diff --cached --quiet; then
            echo "‚ö†Ô∏è Nenhuma altera√ß√£o para commit"
          else
            git commit -m "üöÄ Build completo SuperFlix + JSONs - $(date +'%d/%m %H:%M')"
            git push
            echo "‚úÖ Arquivos commitados e enviados com sucesso!"
          fi
          
      # 9. RELAT√ìRIO FINAL
      - name: Relat√≥rio final
        if: always()
        run: |
          echo ""
          echo "üéâ BUILD COMPLETO!"
          echo ""
          echo "üìä ARQUIVOS GERADOS:"
          echo "1. builds/SuperFlix.cs3 - Plugin principal"
          echo "2. builds/plugins.json - Lista de plugins autom√°tica"
          echo "3. builds/repo.json - Configura√ß√£o do reposit√≥rio"
          echo ""
          echo "üîó URLs PARA USAR:"
          echo ""
          echo "üì± PARA INSTALAR PLUGIN DIRETO:"
          echo "URL: https://raw.githubusercontent.com/${{ github.repository }}/main/builds/SuperFlix.cs3"
          echo ""
          echo "üì¶ PARA ADICIONAR REPOSIT√ìRIO COMPLETO:"
          echo "URL: https://raw.githubusercontent.com/${{ github.repository }}/main/builds/repo.json"
          echo ""
          echo "üìÑ LISTA DE PLUGINS:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/builds/plugins.json"
