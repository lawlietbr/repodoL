name: Build e Release

on: workflow_dispatch

jobs:
  build:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          
      - name: Setup
        uses: actions/setup-java@v3
        with:
          distribution: 'temurin'
          java-version: '11'
          
      - name: Compilar
        id: compile
        run: |
          chmod +x gradlew
          
          # Build com output completo para arquivo
          ./gradlew :SuperFlix:assembleDebug --stacktrace > build.log 2>&1 || true
          
          # Verifica resultado
          if grep -q "BUILD SUCCESSFUL" build.log; then
            echo "âœ… Build OK"
            
            # Encontra arquivo
            file=$(find . -name "*.cs3" -type f | head -1)
            echo "filename=$(basename "$file")" >> $GITHUB_OUTPUT
            echo "filepath=$file" >> $GITHUB_OUTPUT
            
            # Mostra resumo limpo
            echo "ðŸ“¦ Plugin: $(basename "$file")"
          else
            echo "âŒ Build falhou"
            echo ""
            echo "=== ERROS ==="
            grep -E "^e: |error:|FAILED|âœ—|âŒ" build.log | head -20
            exit 1
          fi
          
      - name: Criar release
        if: success()
        run: |
          mkdir -p dist
          
          # Copia arquivo
          cp "${{ steps.compile.outputs.filepath }}" "dist/SuperFlix.cs3"
          
          # JSONs
          cat > dist/plugins.json << EOF
          [
            {
              "name": "SuperFlix",
              "url": "https://raw.githubusercontent.com/${{ github.repository }}/main/dist/SuperFlix.cs3"
            }
          ]
          EOF
          
          echo '{"name":"SuperFlix","pluginLists":["https://raw.githubusercontent.com/'${{ github.repository }}'/main/dist/plugins.json"]}' > dist/repo.json
          
      - name: Commitar
        if: success()
        run: |
          git config user.name "GitHub Actions"
          git config user.email "actions@github.com"
          git add dist/
          git commit -m "ðŸ“¦ $(date +'%H:%M:%S')"
          git push
          
      - name: Resultado
        if: success()
        run: |
          echo ""
          echo "ðŸŽ¯ BUILD COMPLETO!"
          echo ""
          echo "ðŸ”— INSTALAR:"
          echo "https://raw.githubusercontent.com/${{ github.repository }}/main/dist/SuperFlix.cs3"
