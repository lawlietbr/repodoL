name: build do L

on:
  push:
    branches:
      - main
  workflow_dispatch:

jobs:
  build:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # 1. CHECKOUT
      - uses: actions/checkout@v4
        with:
          token: ${{ secrets.GITHUB_TOKEN }}

      # 2. DEBUG: Verificar secrets
      - name: Debug - Verificar Secrets
        run: |
          echo "=== DEBUG SECRETS ==="
          echo "TMDB_API_KEY está definida? ${{ secrets.TMDB_API_KEY != '' }}"
          
          if [ -n "${{ secrets.TMDB_API_KEY }}" ]; then
            KEY="${{ secrets.TMDB_API_KEY }}"
            LENGTH=${#KEY}
            echo "Tamanho da chave: $LENGTH"
            echo "Primeiros 4 caracteres: ${KEY:0:4}***"
          else
            echo "TMDB_API_KEY: NÃO DEFINIDA"
            echo "Tamanho da chave: 0"
          fi
          echo "=== FIM DEBUG ==="

      # 3. SETUP JAVA
      - name: Set up JDK 17
        uses: actions/setup-java@v4 
        with:
          java-version: '17'
          distribution: 'temurin'
          cache: 'gradle'

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 4. DEBUG: Verificar ambiente antes do build
      - name: Debug - Verificar variáveis de ambiente
        run: |
          echo "=== DEBUG VARIÁVEIS DE AMBIENTE ==="
          echo "TMDB_API_KEY (env): $TMDB_API_KEY"
          
          if [ -z "$TMDB_API_KEY" ]; then
            echo "TMDB_API_KEY definida? NÃO"
            echo "Tamanho: 0"
            echo "Valor: VAZIA"
          else
            echo "TMDB_API_KEY definida? SIM"
            echo "Tamanho: ${#TMDB_API_KEY}"
            # Mostrar primeiros e últimos caracteres
            FIRST_PART="${TMDB_API_KEY:0:8}"
            LAST_PART="${TMDB_API_KEY: -4}"
            echo "Valor (oculto): ${FIRST_PART}...${LAST_PART}"
          fi
          echo "=== FIM DEBUG ==="
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}

      # 5. CRIA UM local.properties COM A CHAVE (IMPORTANTE!)
      - name: Criar local.properties com a chave
        run: |
          echo "=== CRIANDO LOCAL.PROPERTIES ==="
          
          # Cria o arquivo local.properties com a chave real
          echo "# Configurações do projeto" > local.properties
          echo "TMDB_API_KEY=$TMDB_API_KEY" >> local.properties
          echo "sdk.dir=/usr/local/lib/android/sdk" >> local.properties
          
          echo "Conteúdo de local.properties (ocultando chave):"
          head -3 local.properties | sed 's/TMDB_API_KEY=.*/TMDB_API_KEY=***/' 
          
          echo "=== FIM ==="
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}

      # 6. DEBUG: Verificar estrutura do projeto
      - name: Debug - Verificar estrutura do projeto
        run: |
          echo "=== ESTRUTURA DO PROJETO ==="
          find . -name "*.kt" | grep -i superflix || true
          find . -name "build.gradle*" | xargs grep -l "TMDB" || true
          echo "=== FIM ==="

      # 7. BUILD com debug aprimorado
      - name: Build with Gradle
        env:
          TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}
          ORG_GRADLE_PROJECT_TMDB_API_KEY: ${{ secrets.TMDB_API_KEY }}  # Para Gradle properties
        run: |
          echo "=== INICIANDO BUILD GRADLE ==="
          
          if [ -z "$TMDB_API_KEY" ]; then
            echo "⚠️  AVISO: TMDB_API_KEY está VAZIA no ambiente do build"
            echo "Isso pode causar problemas no plugin SuperFlix"
          else
            echo "✅ TMDB_API_KEY está definida no ambiente do build"
            echo "Tamanho: ${#TMDB_API_KEY} caracteres"
          fi
          
          # Verificar se temos local.properties
          echo "Verificando local.properties..."
          if [ -f "local.properties" ]; then
            echo "local.properties encontrado"
            if grep -q "TMDB_API_KEY" local.properties; then
              echo "✅ TMDB_API_KEY encontrada em local.properties"
            else
              echo "⚠️  TMDB_API_KEY NÃO encontrada em local.properties"
            fi
          fi
          
          # Criar gradle.properties para garantir
          echo "Criando gradle.properties..."
          echo "org.gradle.project.TMDB_API_KEY=$TMDB_API_KEY" >> gradle.properties
          echo "DEBUG_MODE=true" >> gradle.properties
          
          # Verificar propriedades do Gradle
          echo "Executando gradle properties..."
          ./gradlew properties 2>&1 | grep -i "tmdb\|api_key\|buildconfig" || true
          
          # Task de debug customizada
          echo "Executando task de debug..."
          ./gradlew printDebugInfo --info 2>&1 | tail -50 || true
          
          # Build principal
          echo "Executando build principal..."
          ./gradlew clean assemble --refresh-dependencies --info --stacktrace
          
          echo "=== BUILD COMPLETO ==="

      # 8. DEBUG: Verificar APK gerado
      - name: Debug - Verificar APK gerado
        run: |
          echo "=== VERIFICANDO APK ==="
          find . -name "*.apk" | while read apk; do
            echo "APK: $apk"
            # Tentar extrair e verificar strings
            if command -v strings &> /dev/null; then
              echo "Strings contendo TMDB no APK:"
              strings "$apk" | grep -i "tmdb\|api_key" | head -10 || true
            fi
          done

      # 9. DEBUG: Verificar BuildConfig gerado
      - name: Debug - Verificar BuildConfig gerado
        run: |
          echo "=== DEBUG BUILDCONFIG ==="
          
          # Procurar por BuildConfig gerado
          find . -name "*BuildConfig.java" -type f 2>/dev/null | while read file; do
            echo "=== Arquivo BuildConfig: $file ==="
            
            # Verificar se é do módulo correto
            if echo "$file" | grep -q "superflix"; then
              echo "✅ BuildConfig do módulo SuperFlix encontrado"
            fi
            
            echo "Conteúdo completo do arquivo:"
            cat "$file"
            echo ""
            
            # Verificar TMDB específicamente
            echo "--- Busca por TMDB ---"
            if grep -q "TMDB_API_KEY" "$file"; then
              echo "✅ TMDB_API_KEY encontrada no BuildConfig"
              LINE=$(grep -n "TMDB_API_KEY" "$file")
              LINE_NUM=$(echo "$LINE" | cut -d: -f1)
              LINE_CONTENT=$(echo "$LINE" | cut -d: -f2-)
              echo "Linha $LINE_NUM: $LINE_CONTENT"
              
              # Verificar o valor
              if echo "$LINE_CONTENT" | grep -q '""'; then
                echo "⚠️  AVISO: TMDB_API_KEY está vazia (\"\")"
              elif echo "$LINE_CONTENT" | grep -q "\"[a-zA-Z0-9]\""; then
                echo "✅ TMDB_API_KEY parece ter um valor"
                # Mostrar tamanho do valor
                VALUE=$(echo "$LINE_CONTENT" | sed -n 's/.*TMDB_API_KEY = "\([^"]*\)".*/\1/p')
                if [ -n "$VALUE" ]; then
                  echo "   Tamanho do valor: ${#VALUE} caracteres"
                  echo "   Primeiros 8 chars: ${VALUE:0:8}..."
                fi
              fi
            else
              echo "❌ TMDB_API_KEY NÃO encontrada no BuildConfig"
            fi
            echo "====================="
          done
          
          echo "=== FIM DEBUG ==="
     - name: Debug - Verificar código do Gradle
  run: |
    echo "=== CÓDIGO DO BUILD.GRADLE.KTS ==="
    cat ./SuperFlix/build.gradle.kts
    
    echo ""
    echo "=== BUSCANDO POR '***' NO CÓDIGO ==="
    grep -n "\*\*\*" ./SuperFlix/build.gradle.kts || echo "Não encontrado"
    
    echo ""
    echo "=== BUSCANDO POR 'buildConfigField' ==="
    grep -n "buildConfigField" ./SuperFlix/build.gradle.kts